name: 'Test Action'

on:
  push:

jobs:
  create-cache:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout Repository ğŸ›ï¸'
        uses: 'actions/checkout@v3'
      - name: 'Use Node.js ğŸ“—'
        uses: 'actions/setup-node@v3'
        with:
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      - name: 'Delete pre-existing test cache ğŸ”¥'
        run: |-
          gh extension install actions/gh-actions-cache
          gh actions-cache delete "test" \
            -R ${{ github.repository }} -B ${{ github.ref_name }} \
            --confirm

      - name: 'Ensure node_modules does not exist âœ…'
        run: |-
          dir="$(pwd)/node_modules"
          if [ ! -f "$dir/.package-lock.json" ]; then
            echo "âœ… $dir does not exist."
          else
            echo "âŒ $dir already exists."
            echo "Contents of $dir:"
            ls -lha "$dir"
            exit 1
          fi

      - name: 'Install node modules ğŸ“¥'
        id: 'install'
        uses: './'
        with:
          cache-key: 'test'

      - name: 'Ensure node_modules exists âœ…'
        run: |-
          dir="$(pwd)/node_modules"
          if [ -d "$dir" ]; then
            echo "âœ… $dir exists."
          else
            echo "âŒ $dir does not exist."
            dir_up=$(dirname $dir)
            echo "Contents of $dir_up:"
            ls -lha "$dir_up"
            exit 1
          fi

  test-cache:
    runs-on: 'ubuntu-latest'
    needs:
      - 'create-cache'
    steps:
      - name: 'Restore test cache ğŸ§©'
        uses: 'actions/cache/restore@v3'
        id: 'restore-cache'
        with:
          key: '${{ steps.install.outputs.cache-key }}'
          path: '${{ runner.temp }}/cache-${{ steps.install.outputs.cache-key }}'
          fail-on-cache-miss: 'true'

      - name: 'Ensure cache includes node_modules âœ…'
        run: |-
          dir="${{ runner.temp }}/cache-${{ steps.install.outputs.cache-key }}"
          pkg_lock="$dir/.package-lock.json"
          if [ -f "$pkg_lock" ]; then
            echo "âœ… $pkg_lock exists."
          else
            echo "âŒ $pkg_lock does not exist."
            echo "Contents of $dir:"
            ls -lha "$dir"
            exit 1
          fi

  cleanup:
    runs-on: 'ubuntu-latest'
    needs:
      - 'create-cache'
      - 'test-cache'
    if: 'always()'
    steps:
      - name: 'Delete test cache ğŸ”¥'
        run: |-
          gh extension install actions/gh-actions-cache
          gh actions-cache delete "test" \
            -R ${{ github.repository }} -B ${{ github.ref_name }} \
            --confirm
