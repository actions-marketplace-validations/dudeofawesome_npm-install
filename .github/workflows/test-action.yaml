name: 'Test Action'

on:
  push:

jobs:
  test:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout Repository ğŸ›ï¸'
        uses: 'actions/checkout@v3'
      - name: 'Use Node.js ğŸ“—'
        uses: 'actions/setup-node@v3'
        with:
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: 'Ensure node_modules does not exist âœ…'
        run: |-
          dir="$(pwd)/node_modules"
          if [ ! -d "$dir" ]; then
            echo "âœ… $dir does not exist."
          else
            echo "âŒ $dir already exists."
            exit 1
          fi

      - name: 'Install node modules ğŸ“¥'
        id: 'install'
        uses: './action.yaml'
        with:
          cache-key: 'test'

      - name: 'Ensure node_modules exists âœ…'
        run: |-
          dir="$(pwd)/node_modules"
          if [ -d "$dir" ]; then
            echo "âœ… $dir exists."
          else
            echo "âŒ $dir does not exist."
            exit 1
          fi

      - name: 'Restore test cache ğŸ§©'
        uses: 'actions/cache/restore@v3'
        id: 'restore-cache'
        with:
          key: '${{ steps.install.outputs.cache-key }}'
          path: '${{ runner.temp }}/cache-${{ steps.install.outputs.cache-key }}'
          fail-on-cache-miss: 'true'

      - name: 'Ensure cache includes node_modules âœ…'
        run: |-
          pkg_lock="${{ runner.temp }}/cache-${{ steps.install.outputs.cache-key }}/.package-lock.json"
          if [ -f "$pkg_lock" ]; then
            echo "âœ… $pkg_lock exists."
          else
            echo "âŒ $pkg_lock does not exist."
            exit 1
          fi
